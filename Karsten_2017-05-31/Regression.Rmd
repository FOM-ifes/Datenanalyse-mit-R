---
title: "Einführung Lineare Regression mit R"
author: "Prof. Dr. Karsten Lübke"
date: "SoSe 2017"
output:
  beamer_presentation:
    includes:
      in_header: fom-ifes-style-sheet.tex
    keep_tex: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  size = "small",
  fig.width = 10,
  fig.asp = 0.618)

ex <- 0

td <- try(read.csv2("tips.csv"), silent =TRUE)
if (class(td)=="try-error") download.file("https://goo.gl/whKjnl", destfile = "tips.csv")

tips <- read.csv2("tips.csv")

require(mosaic)
require(knitr)

set.seed(1896)
                 
```

## Modellierung

- *Supervised Learning*: Kann ein Teil der Variation einer abhängigen Variable $y$ durch unabhängige Variable(n) $x$ modelliert werden: $y = f(x) + \epsilon$
- Schätze $\hat{f}$ anhand der Daten
- Annahme: $f$ ist *lineare* Funktion: $y= \beta_0 + \beta_1 \cdot x + \epsilon$ Hier: $y$ numerisch, nur eine unabhängige $x$
- Kleinste Quadrate Kriterium: $\hat{\beta}$ so, dass $\min \sum \epsilon^2_i$ 

## Vorbereitung: Trinkgeld und Rechnungshöhe

Einlesen der "Tipping"^[Bryant, P. G. and Smith, M (1995) Practical Data Analysis: Case Studies in Business Statistics. Homewood, IL: Richard D. Irwin Publishing] Daten sowie laden des Pakets `mosaic`. Zufallszahlengenerator setzen.

```{r, eval= FALSE, message=FALSE}
download.file("https://goo.gl/whKjnl", destfile = "tips.csv")
tips <- read.csv2("tips.csv")
# Alternativ - heruntergeladene Datei einlesen:
# tips <- read.csv2(file.choose()) 

library(mosaic) # Paket
set.seed(1896) # Zufallzahlengenerator
```
## Streudiagramm: Trinkgeld und Rechnungshöhe

```{r, fig.align="center", out.width="50%"}
xyplot(tip ~ total_bill, data = tips)
```

## Übung  `r ex <- ex+1; ex`: Korrelation Trinkgeld und Rechnungshöhe

Welche Aussage stimmt vermutlich für den Korrelationskoeffizient zwischen Trinkgeld und Rechnungshöhe?

- A: Der Korrelationskoeffizient liegt bei $r = `r -round(cor(tip ~ total_bill, data = tips),2)`$
- B: Der Korrelationskoeffizient liegt bei $r = `r -0.5*round(cor(tip ~ total_bill, data = tips),2)`$
- C: Der Korrelationskoeffizient liegt bei $r = `r round(cor(tip ~ total_bill, data = tips),2)`$
- D: Der Korrelationskoeffizient liegt bei $r = `r 0.5*round(cor(tip ~ total_bill, data = tips),2)`$

## Lineare Regression  Trinkgeld und Rechnungshöhe

```{r}
erglm1 <- lm(tip ~ total_bill, data = tips)
summary(erglm1)
```

## Übung `r ex <- ex+1; ex`: Regression Trinkgeld und Rechnungshöhe

Welche Aussage stimmt?

- A: Im Mittel steigt mit jedem Dollar Trinkgeld die Rechnungshöhe um `r round(erglm1$coefficients[1],2)`
- B: Im Mittel steigt mit jedem Dollar Trinkgeld die Rechnungshöhe um `r round(erglm1$coefficients[2],2)`
- C: Im Mittel steigt mit jedem Dollar Rechnungshöhe das Trinkgeld um `r round(erglm1$coefficients[1],2)`
- D: Im Mittel steigt mit jedem Dollar Rechnungshöhe das Trinkgeld um `r round(erglm1$coefficients[2],2)`

## Regressionsgerade

```{r, fig.align="center", out.width="50%"}
plotModel(erglm1)
```


## Geschätzte Regressionsgleichung

Die geschätzte Gleichung lautet:

$$ y_i = `r round(erglm1$coefficients[1],2)` + `r round(erglm1$coefficients[2],2)` \cdot x_i + \epsilon_i $$

Die Punktprognose lautet dann:

$$ \hat{y}_i = `r round(erglm1$coefficients[1],2)` + `r round(erglm1$coefficients[2],2)` \cdot x_i  $$

## Übung `r ex <- ex+1; ex`: Prognose der Trinkgeldhöhe aus Rechnungshöhe

Für $x_0 = 10$ lautet die Prognose $\hat{y}_0 = `r round(erglm1$coefficients[1],2)` + `r round(erglm1$coefficients[2],2)` \cdot 10 = `r round(erglm1$coefficients[1],2) +  round(erglm1$coefficients[2],2)*10`$.

Stimmt die Aussage: Bei einer Rechnungshöhe von $10$\$ wird das Trinkgeld mit Sicherheit bei $`r round(erglm1$coefficients[1],2) +  round(erglm1$coefficients[2],2)*10`$\$ liegen?

- Ja.
- Nein.

## Prognoseintervalle

```{r}
predict(erglm1, # Modell
        # Neue Beobachtung mit x=10:
        newdata = data.frame(total_bill = 10), 
        # Prognoseintervall:
        interval  = "prediction") 
```


## Übung `r ex <- ex+1; ex`: Bestimmheitsmaß

Es gilt: $R^2=1-\frac{\sum_{i=1}^n (y_i-\hat{y}_i)^2}{\sum_{i=1}^n (y_i-\bar{y})^2}=`r round(summary(erglm1)$r.squared,4)`$ (`Multiple R-squared`). Welche Aussage stimmt?

- A: Das Modell ist zu `r round(summary(erglm1)$r.squared*100)`\% korrekt
- B: `r round(summary(erglm1)$r.squared*100)`\% der Beobachtungen werden richtig modelliert
- C: `r round(summary(erglm1)$r.squared*100)`\% der Variation der Rechnungshöhe werden modelliert
- D: `r round(summary(erglm1)$r.squared*100)`\% der Variation der Trinkgeldhöhe werden modelliert

## Bootsrap Steigungskoeffizient

```{r,  fig.align="center", out.width="20%"}
Bootvtlg <- do(10000) *
  coef(lm(tip ~ total_bill, data = resample(tips)))[2]

histogram( ~ total_bill, data = Bootvtlg)
quantile( ~ total_bill, data = Bootvtlg, 
          probs = c(0.025, 0.975))
```

## Permutationstest Steigung (I/II)

Wenn $H_0: \beta_1=0$ gilt, so sollte $y$ in keinen (linearen) Zusammenhang zu $x$ stehen: 

```{r}
Nullvtlg <- do(10000) *
  coef(lm(tip ~ shuffle(total_bill), data = tips))[2]
```

## Permutationstest Steigung (II/II)


```{r,  fig.align="center", out.width="33%"}
histogram( ~ total_bill, data = Nullvtlg)
quantile( ~ total_bill, data = Nullvtlg, 
          probs = c(0.025, 0.975))
```


## Übung `r ex <- ex+1; ex`: Permutationstest Steigung

Welche Aussage stimmt?

- A: Die Beobachtete Steigung der Stichprobe $\hat{\beta}_1=`r round(erglm1$coefficients[2],2)`$ ist unter $H_0: \beta_1=0$ ein üblicher Wert.
- B: Die Beobachtete Steigung der Stichprobe $\hat{\beta}_1=`r round(erglm1$coefficients[2],2)`$ ist unter $H_0: \beta_1=0$ kein üblicher Wert.

## Verteilung Residuen

```{r,  fig.align="center", out.width="50%"}
histogram( ~ resid(erglm1))
```

## Verteilung Residuen und angepasste Werte

```{r,  fig.align="center", out.width="50%"}
xyplot(resid(erglm1) ~ fitted(erglm1))
```

## Übung `r ex <- ex+1; ex`: Verteilung Residuen und angepasste Werte

Welche Aussage stimmt?

- A: Die Varianz der Residuen scheint unabhängig von der Höhe der angepassten Werte zu sein.
- B: Die Varianz der Residuen scheint mit der der Höhe der angepassten Werte zu steigen.
- C: Die Varianz der Residuen scheint mit der der Höhe der angepassten Werte zu fallen.

## Trinkgeld und Geschlecht

```{r, fig.align="center", out.width="33%"}
mean(tip ~ sex, data = tips)
xyplot(tip ~ sex, data = tips)
```

## Regression Trinkgeld und Geschlecht

```{r}
erglm2 <- lm(tip ~ sex, data = tips)
summary(erglm2)
```

## Übung `r ex <- ex+1; ex`: Regression Trinkgeld und Geschlecht

Welche Aussage stimmt?

- A: Im Mittel geben Männer `r round(erglm2$coefficients[2],2)` mehr Trinkgeld als Frauen
- B: Im Mittel geben Frauen `r round(erglm2$coefficients[2],2)` mehr Trinkgeld als Männer
- C: Männer geben `r round(erglm2$coefficients[2],2)` mehr Trinkgeld als Frauen
- D: Frauen geben `r round(erglm2$coefficients[2],2)` mehr Trinkgeld als Männer

## Multiple Regression

Modelliere Trinkgeldhöhe als lineare Funktion von Rechnungshöhe und Geschlecht

```{r}
erglm3 <- lm(tip ~ total_bill + sex, data = tips)
summary(erglm3)
```

## Regressionsergebnis: `Coefficients`

```{r, echo=FALSE}
kable(summary(erglm3)$coefficients)
```

## Übung `r ex <- ex+1; ex`: Regression Trinkgeld und Geschlecht

Stimmt die Aussage: Gegeben die Rechnungshöhe geben Männer im Mittel mehr Trinkgeld als Frauen.

- Ja.
- Nein.

## Permutationstest Steigung Geschlecht 

```{r}
Nullvtlg <- do(10000) *
  coef(lm(tip ~ total_bill + shuffle(sex), data = tips))[3]

prop( ~ abs(sexMale) >= abs(coef(erglm3)[3]), 
      data = Nullvtlg)
```

## Übung `r ex <- ex+1; ex`: Inferenz Regression Trinkgeld und Geschlecht

Gegeben die Rechnungshöhe, kann die Nullhypothese $\beta_2=\beta_{\text{sex}}=0$ zum Signifikanzniveau $5\%$ verworfen werden?

- Ja.
- Nein.


## Übung `r ex <- ex+1; ex`: Interpretation Regression

Welches ist die korrekteste Interpretation von $\hat{\beta}_1=\hat{\beta}_{\text{total\_bill}} = `r round(coef(erglm3)[2],2)`$?

- A: Mit jedem \$ Rechnungshöhe steigt das Trinkgeld um `r round(coef(erglm3)[2],2)`\$.
- B: Mit jedem \$ Rechnungshöhe steigt das Trinkgeld im Mittel um `r round(coef(erglm3)[2],2)`\$.
- C: Mit jedem \$ Rechnungshöhe steigt das Trinkgeld im Mittel um `r round(coef(erglm3)[2],2)`\$, gegeben alle anderen Faktoren bleiben konstant.
- D: In einem linearen Modell steigt mit jedem \$ Rechnungshöhe das Trinkgeld im Mittel um `r round(coef(erglm3)[2],2)`\$, gegeben alle anderen Faktoren bleiben konstant.
- E: In der Stichprobe steigt in einem linearen Modell mit jedem \$ Rechnungshöhe das Trinkgeld im Mittel um `r round(coef(erglm3)[2],2)`\$, gegeben alle anderen Faktoren bleiben konstant.

## Offene Übung: Rechnungshöhe

Modellieren Sie die Rechnungshöhe als Funktion der Anzahl Personen sowie der Tageszeit.


